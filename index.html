<!DOCTYPE html>
<html lang = "en">
<head>
    <title>Road Sign Sticker</title>
    <meta charset = "utf-8">
    <script src = "https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
    <script src = "https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image@2.6/dist/dom-to-image.min.js"></script>
    <style>
        html {
            --heading-color: #ffffff;
            --heading-rotate: -90deg;
            --mode-color: #ffffff;
        }
        * {
            margin: 0px;
            padding: 0px;
            border: 0px;
        }
        input, button, p {
            font-family: Arial, sans-serif;
            font-size: 20px;
            padding: 5px 7px;
            margin: 10px;
        }
        input, button {
            border-radius: 0px;
            text-decoration: none;
            font-weight: normal;
            background-color: #f8f8f8;
            color: black;
            -webkit-appearance: none;
            border: 1px solid black;
        }
        input {
            flex: 1;
            width: 200px;
        }
        input[type="color"] {
            padding: 0px;
            min-width: 23px;
        }
        .row-div {
            margin: 0px 10px;
            display: flex;
            flex-direction: row;
            overflow-x: auto;
        }
        #sign {
            width: 600px;
            height: 400px;
            border-radius: 25px;
            margin: 10px;
            display: flex;
            position: relative;
        }
        #sign-divider {
            position: absolute;
            top: 56%;
            left: 0%;
            height: 6px;
            width: 100%;
        }
        #sign-heading {
            position: absolute;
            top: 33%;
            left: -21%;
            pointer-events: none;
        }
        #sign-dest {
            position: absolute;
            top: 60%;
            left: 23%;
            font-size: 48px;
            font-weight: bold;
        }
        #route-distance {
            position: absolute;
            top: 76%;
            left: calc(23% + 10px);
            display: flex;
            flex-direction: row;
        }
        #sign-route {
            font-size: 30px;
            font-weight: bold;
            padding: 3px 5px;
            border-style: solid;
            border-radius: 18px;
            border-width: 5px;
            margin: 10px 7px;
        }
        #sign-distance {
            padding: 7px 0px;
            font-size: 32px;
            font-weight: bold;
            margin: 10px 7px;
        }
        #sign-gtfs-container {
            position: absolute;
            top: -78%;
            left: 11%;
            pointer-events: none;
        }
        #sign-agency {
            position: absolute;
            top: 34%;
            left: 66%;
            font-size: 48px;
            font-weight: bold;
        }
        #sign-logo {
            position: absolute;
            top: 17px;
            left: 110px;
            width: 192px;
            height: 192px;
        }
    </style>
</head>
<body onload = "brython (0)">
    <noscript>
        <p id = "start">JavaScript is required to use this website.</p>
    </noscript>
    <div class="row-div" style="margin-top: 10px;">
        <button id="detect">Detect&nbsp;Location</button>
        <input id="lat" type="text" placeholder="Latitude" value="44.3805465">
        <input id="lon" type="text" placeholder="Longitude" value="-73.2270890">
        <input id="dest" type="text" placeholder="Destination" value="Hack Club">
        <button id="generate" style="background-color: #a0ffa0;">Generate!</button>
    </div>
    <div class="row-div">
        <p>Background:</p>
        <input id="background" type="color" value="#004250">
        <p>Text:</p>
        <input id="text" type="color" value="#ffffff">
        <p>Route&nbsp;#:</p>
        <input id="route" type="color" value="#e05c6e">
        <p>Heading&nbsp;&amp;&nbsp;Logo:</p>
        <input id="heading" type="color" value="#ffd74f">
        <p>Agency&nbsp;Icon:</p>
        <input id="agency" type="color" value="#ffffff">
        <p>Divider:</p>
        <input id="divider" type="color" value="#c4c4c4">
    </div>
    <div class="row-div">
        <p>Please select an agency:</p>
        <div id="agencies" class="row-div" style="margin: 0px;">
            <button disabled style="background-color: #ffa0a0;">Click 'Generate!' to load agencies</button>
        </div>
    </div>
    <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <p>Click the sign to refresh the preview.</p>
        <div id="sign">
            <div id="sign-divider"></div>
            <load-svg id="sign-heading" src="https://upload.wikimedia.org/wikipedia/commons/1/12/Right_arrow.svg">
                <style>
                    svg {
                        transform: rotate(var(--heading-rotate)) scale(0.22);
                    }
                    svg * {
                        fill: var(--heading-color) !important;
                    }
                </style>
            </load-svg>
            <p id="sign-dest"></p>
            <div id="route-distance">
                <p id="sign-route"></p>
                <p id="sign-distance"></p>
            </div>
            <div id="sign-gtfs-container"></div>
            <p id="sign-agency"></p>
            <img id="sign-logo"></img>
        </div>
    </div>

    
    <script type = "text/python">
        from browser import document, ajax, html, window
        import re

        svgs = {
            "gtfs_0": "https://corsproxy.io/?url=https://www.svgrepo.com/show/490253/tram.svg",
            "gtfs_1": "https://corsproxy.io/?url=https://www.svgrepo.com/show/346415/subway-fill.svg",
            "gtfs_2": "https://corsproxy.io/?url=https://www.svgrepo.com/show/490124/high-speed-train.svg",
            "gtfs_3": "https://corsproxy.io/?url=https://www.svgrepo.com/show/490599/bus-3.svg",
            "gtfs_4": "https://corsproxy.io/?url=https://www.svgrepo.com/show/480891/ferry-1.svg",
            "gtfs_5": "https://corsproxy.io/?url=https://www.svgrepo.com/show/490252/tram-side-view.svg", # No cable car icon
            "gtfs_6": "https://corsproxy.io/?url=https://www.svgrepo.com/show/480914/ropeway-5.svg",
            "gtfs_7": "https://corsproxy.io/?url=https://www.svgrepo.com/show/509484/cable-railway.svg",
            "gtfs_11": "https://corsproxy.io/?url=https://www.svgrepo.com/show/490255/trolleybus.svg",
            "gtfs_12": "https://corsproxy.io/?url=https://www.svgrepo.com/show/403846/monorail.svg"
        }
        route_api = "https://transit.land/api/v2/rest/routes?lon={lon}&lat={lat}&radius={radius}&apikey=" + window.apikey
        road_api = "https://overpass-api.de/api/interpreter?data=[out:json];way[highway~%22^(motorway|trunk)$%22][%22ref%22](around:{radius},{lat},{lon});out%20tags%20geom%20qt;"
        favicon_api = "https://www.google.com/s2/favicons?domain={domain}&sz=256"
        radius = 10000 # 10 km
        sign_data = {
            "heading": 0,
            "route": "HC22",
            "distance": "375m",
            "agency": "MRT",
            "type": "gtfs_1",
            "domain": "https://www.lta.gov.sg/"
        }


        def abbreviate (agency):
            return "".join (re.findall ("[A-Z]", agency)) # Simple abbreviation using capital letters

        def generate (ev):
            global svgs, route_api, road_api, radius
            ajax.get (route_api.format (lat = document ["lat"].value, lon = document ["lon"].value, radius = radius), oncomplete = route_complete, cache = True)
        document ["generate"].bind ("click", generate)

        def route_complete (res):
            pass

        def geolocate (ev):
            def success (pos):
                document ["lat"].value = pos.coords.latitude
                document ["lon"].value = pos.coords.longitude
            window.navigator.geolocation.getCurrentPosition (success)
        document ["detect"].bind ("click", geolocate)

        def update_sign (ev):
            global sign_data
            document ["sign"].style.backgroundColor = document ["background"].value
            document ["sign-divider"].style.backgroundColor = document ["divider"].value

            document.documentElement.style.setProperty ("--heading-color", document ["heading"].value)
            document.documentElement.style.setProperty ("--heading-rotate", f"{sign_data ['heading'] - 90}deg")

            document ["sign-dest"].style.color = document ["text"].value
            document ["sign-dest"].innerHTML = document ["dest"].value

            document ["sign-route"].style.backgroundColor = document ["route"].value
            document ["sign-route"].style.borderColor = document ["text"].value
            document ["sign-route"].style.color = document ["text"].value
            document ["sign-route"].innerHTML = sign_data ["route"]

            document ["sign-distance"].style.color = document ["text"].value
            document ["sign-distance"].innerHTML = sign_data ["distance"]

            document ["sign-agency"].style.color = document ["agency"].value
            document ["sign-agency"].innerHTML = sign_data ["agency"]

            document ["sign-logo"].src = favicon_api.format (domain = sign_data ["domain"])

            gtfs_type_html = f"""
                <load-svg id="sign-gtfs-type" src="{svgs [sign_data ['type']]}">
                    <style>
                        svg {{
                            transform: scale(0.17);
                        }}
                        svg *:not([fill="none"]) {{
                            fill: {document ["agency"].value} !important;
                        }}
                    </style>
                </load-svg>
            """
            document ["sign-gtfs-container"].innerHTML = gtfs_type_html

        document ["sign"].bind ("click", update_sign)
        
        update_sign (None)
    </script>
    <script>
        customElements.define ('load-svg', class extends HTMLElement {
            async connectedCallback () {
            this.attachShadow ({mode: "open"})
                .innerHTML = await (await fetch (this.getAttribute ("src"))).text ();
            this.shadowRoot.append (...this.childNodes);
            }
        });
        var tk = null;
        while (tk == null || tk == "") {
            tk = prompt ("Please enter a transit.land API key:", localStorage.getItem ("transitland_apikey") || "");
        }
        localStorage.setItem ("transitland_apikey", tk);
        window.apikey = tk;
    </script>
</body>
